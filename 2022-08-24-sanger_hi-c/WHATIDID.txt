### Get fasta from sanger
samtools fastq -@ 10 -1 out_1.fq.gz -2 out_2.fq.gz sanger.cram

# YAHS
git clone https://github.com/c-zhou/yahs.git
cd yahs
make
cd ..
ln -s ~/archive_hive/ghernandez/2022-02-Ephemera_nanopore/2022-06-Flye_parameters_exploration/2022-06-19-Sample_1_and_sample_2_read_length_1kb/results/assembly.fasta.gz .

### Map with Aritma pipeline from Yahs
bwa index -a bwtsw -p reference input/assembly.fasta.gz
bwa mem -t 8 assembly.fasta.gz out_2.fq.gz | samtools view -@ 8 -Sb -> ../tmp/mapped_reads_2.bam
bwa mem -t 8 assembly.fasta.gz out_1.fq.gz | samtools view -@ 8 -Sb -> ../tmp/mapped_reads_1.bam
samtools view -h mapped_reads_1.bam | perl filter_five_end.pl | samtools view -Sb -> filtered_mapped_reads_1.bam
samtools view -h mapped_reads_2.bam | perl filter_five_end.pl | samtools view -Sb -> filtered_mapped_reads_2.bam

perl two_read_bam_combiner.pl filtered_mapped_reads_1.bam filtered_mapped_reads_2.bam samtools 10 | samtools view -bS -t ../input/assembly.fasta.gz.fai - | samtools sort -@ 8 -o combined_filtered.bam -

java -Xmx4G -Djava.io.tmpdir=temp/ -jar picard.jar AddOrReplaceReadGroups INPUT=tmp/combined_filtered.bam OUTPUT=tmp/combined_filtered_added_group.bam ID=sanger1 LB=sanger1 SM=ephemera PL=ILLUMINA PU=none

### YAHS
cd yahs
./yahs ../input/assembly.fasta.gz ../tmp/combined_filtered_added_group.bam -o 2022_08_30_first_run

### JUICER
(./juicer pre 2022_08_30_first_run.bin 2022_08_30_first_run_scaffolds_final.agp ../input/assembly.fasta.gz.fai | sort -k2,2d -k6,6d -T ./ --parallel=8 -S32G | awk 'NF' > alignments_sorted.txt.part) && (mv alignments_sorted.txt.part alignments_sorted.txt)
cut -f 1,2 assembly.fasta.gz.fai > ../Contact_maps_visualization/scaffolds_final.chrom.sizes

### HIC2COOL	

### Filter BAM
#Â As the bam file appers to be reporting non-mapped regions, I have filtered. The big file is too noizy and the 
# visualization doesn't work

# --exclude-flags 4 (UNMAP)
samtools view --bam --exclude-flags 4 ../tmp/combined_filtered_added_group.bam > 2022_09_23_mapped.ba

# I will use this new bam file to run Yahs again and use its output fro visualization
./yahs/yahs input/assembly.fasta.gz tmp/2022_09_23_mapped.bam -o tmp_yahs/2022-10-10-filtered_bam   

#Trying to figure out a map quality and the effect of the filtereing. 
samtools view tmp/2022_09_23_mapped.bam | cut -f 5 > tmp/vector_qualities_2022_10_10.txt
samtools depth -a tmp/2022_09_23_mapped.bam > tmp/2022_09_23_depth_samtools

#Run Yahs again with mapquality fileter of 20
./yahs/yahs -q 20 input/assembly.fasta.gz tmp/2022_09_23_mapped.bam -o tmp_yahs/2022-10-11-filtered_mapq_bam 

#Create input file for Juicer
(yahs/juicer pre tmp_yahs/2022-10-11-filtered_mapq_bam.bin tmp_yahs/2022-10-11-filtered_mapq_bam_scaffolds_final.agp input/assembly.fasta.gz.fai | sort -k2,2d -k6,6d -T ./ --parallel=8 -S32G | awk 'NF' > alignments_sorted.txt.part) && (mv alignments_sorted.txt.part tmp_yahs/2022-10-11-alignments_sorted.txt)
